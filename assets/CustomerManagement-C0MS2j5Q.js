import{_ as Y,r as d,c as Z,o as ee,a as n,b as e,d as v,t as a,F as $,e as M,w as E,f as P,v as U,g as i,n as te,h as se}from"./index-DQsCC5S4.js";import{g as le,u as ae,a as q,c as oe,r as ne,b as ie}from"./employeeApi-D5Bbbajn.js";const ue={class:"customer-management"},ce={key:0,class:"loading-message"},re={key:1,class:"error-message"},de={key:2,class:"customers-section"},me={class:"customers-table"},ve=["onClick"],pe={key:3,class:"no-customers-message"},ye={class:"customer-info"},be={key:0,class:"error-message"},fe={class:"accounts-section"},he={key:0,class:"loading-message"},ge={key:1,class:"no-accounts-message"},ke={key:2,class:"accounts-table"},_e=["onClick"],Le=["onClick"],Ce=["onClick"],Ae={class:"transactions-section"},Fe={key:0,class:"loading-message"},we={key:1,class:"no-transactions-message"},Ne={key:2,class:"transactions-table"},Te=["title","onClick"],Be=["title","onClick"],Ie={key:0},xe={key:1},De=["title","onClick"],$e={class:"expand-popup"},Me={class:"popup-header"},Ee={class:"popup-title"},Pe={class:"popup-value"},Ue={class:"limits-form"},Ve={class:"form-group"},Re={class:"form-group"},Se={class:"form-group"},ze={__name:"CustomerManagement",setup(qe){const _=d([]),f=d(!1),u=d(null),r=d(null),p=d([]),L=d([]),N=d(!1),T=d(!1),B=d(!1),C=d(null),m=d({absoluteLimit:0,dailyLimit:0,dailyTransferLimit:0}),I=Z(()=>!p.value||!p.value.length?[]:p.value.map(l=>l.iban)),h=d({visible:!1,value:"",label:""});function x(l){return!r.value||!I.value.length?"":I.value.includes(l.toIban)?"amount-positive":I.value.includes(l.fromIban)?"amount-negative":""}const j=async()=>{var l,s;f.value=!0,u.value=null;try{const t=await le();_.value=t.data}catch(t){console.error("Failed to fetch customers:",t),u.value=((s=(l=t.response)==null?void 0:l.data)==null?void 0:s.message)||t.message||"Failed to fetch customers."}finally{f.value=!1}},G=async l=>{r.value=l,u.value=null,await Promise.all([A(l.id),H(l.id)])},A=async l=>{var s,t;N.value=!0;try{const o=await q(l);p.value=o.data}catch(o){console.error("Failed to fetch customer accounts:",o),u.value=((t=(s=o.response)==null?void 0:s.data)==null?void 0:t.message)||o.message||"Failed to fetch accounts."}finally{N.value=!1}},H=async l=>{var s,t;T.value=!0;try{const w=(await q(l)).data,g=[];for(const y of w){const b=await ie(y.iban);g.push(...b.data)}L.value=g.sort((y,b)=>new Date(b.timestamp)-new Date(y.timestamp))}catch(o){console.error("Failed to fetch customer transactions:",o),u.value=((t=(s=o.response)==null?void 0:s.data)==null?void 0:t.message)||o.message||"Failed to fetch transactions."}finally{T.value=!1}},J=l=>{C.value=l,m.value={absoluteLimit:l.absoluteLimit,dailyLimit:l.dailyLimit,dailyTransferLimit:l.dailyTransferLimit},B.value=!0},K=async()=>{var l,s;if(C.value)try{const t={absoluteLimit:Number(m.value.absoluteLimit),dailyLimit:Number(m.value.dailyLimit),dailyTransferLimit:Number(m.value.dailyTransferLimit)};await ae(C.value.iban,t),await A(r.value.id),F()}catch(t){console.error("Failed to update account limits:",t),u.value=((s=(l=t.response)==null?void 0:l.data)==null?void 0:s.message)||t.message||"Failed to update limits."}},O=async l=>{var w,g,y,b,S;const s=p.value.find(c=>c.iban===l),t=s?s.balance.toFixed(2):"0.00";let o=`Are you sure you want to close account ${l}?`;if(s&&s.balance!==0?o=`Account ${l} has a balance of €${t}. The account balance must be zero before closing. Do you want to proceed anyway?`:o=`Are you sure you want to close account ${l}? (Balance: €${t})`,!!confirm(o))try{await oe(l),await A(r.value.id),u.value=null}catch(c){if(console.error("Failed to close account:",c),console.error("Error response:",c.response),console.error("Error status:",(w=c.response)==null?void 0:w.status),console.error("Error data:",(g=c.response)==null?void 0:g.data),((y=c.response)==null?void 0:y.status)===400){const k=c.response.data;if(typeof k=="string"&&(k.includes("balance must be zero")||k.includes("Current balance:"))){const z=k.match(/Current balance: ([\d.]+)/),X=z?`€${parseFloat(z[1]).toFixed(2)}`:"a non-zero amount";u.value=`Cannot close account due to existing balance of ${X}. Please transfer all funds to another account before closing.`}else u.value=k||"Failed to close account due to validation error."}else((b=c.response)==null?void 0:b.status)===500?u.value="An unexpected server error occurred while closing the account. Please try again later.":(S=c.response)!=null&&S.data?typeof c.response.data=="string"?u.value=c.response.data:c.response.data.message?u.value=c.response.data.message:u.value="Failed to close account.":u.value=c.message||"Failed to close account. Please check your connection and try again.";console.log("Final error message set:",u.value)}},Q=async l=>{var s,t;try{await ne(l),await A(r.value.id)}catch(o){console.error("Failed to reopen account:",o),u.value=((t=(s=o.response)==null?void 0:s.data)==null?void 0:t.message)||o.message||"Failed to reopen account."}},V=()=>{r.value=null,p.value=[],L.value=[],u.value=null},F=()=>{B.value=!1,C.value=null,m.value={absoluteLimit:0,dailyLimit:0,dailyTransferLimit:0}},W=l=>new Date(l).toLocaleString();function D(l,s){l&&(h.value={visible:!0,value:l,label:s})}function R(){h.value={visible:!1,value:"",label:""}}return ee(()=>{j()}),(l,s)=>(i(),n("div",ue,[s[15]||(s[15]=e("h2",null,"Customer Management",-1)),f.value?(i(),n("div",ce," Loading customers... ")):v("",!0),u.value?(i(),n("div",re,a(u.value),1)):v("",!0),!f.value&&!u.value&&_.value.length>0?(i(),n("div",de,[e("table",me,[s[5]||(s[5]=e("thead",null,[e("tr",null,[e("th",null,"Name"),e("th",null,"Email"),e("th",null,"BSN"),e("th",null,"Phone"),e("th",null,"Actions")])],-1)),e("tbody",null,[(i(!0),n($,null,M(_.value,t=>(i(),n("tr",{key:t.id},[e("td",null,a(t.firstName)+" "+a(t.lastName),1),e("td",null,a(t.email),1),e("td",null,a(t.bsn),1),e("td",null,a(t.phone),1),e("td",null,[e("button",{onClick:o=>G(t),class:"view-btn"}," View Details ",8,ve)])]))),128))])])])):v("",!0),!f.value&&!u.value&&_.value.length===0?(i(),n("div",pe," No customers found. ")):v("",!0),r.value?(i(),n("div",{key:4,class:"modal-overlay",onClick:V},[e("div",{class:"modal-content",onClick:s[0]||(s[0]=E(()=>{},["stop"]))},[e("div",{class:"modal-header"},[s[6]||(s[6]=e("h3",null,"Customer Details",-1)),e("button",{onClick:V,class:"close-btn"},"×")]),e("div",ye,[e("h4",null,a(r.value.firstName)+" "+a(r.value.lastName),1),e("p",null,"Email: "+a(r.value.email),1),e("p",null,"BSN: "+a(r.value.bsn),1),e("p",null,"Phone: "+a(r.value.phone),1)]),u.value?(i(),n("div",be,a(u.value),1)):v("",!0),e("div",fe,[s[8]||(s[8]=e("h4",null,"Accounts",-1)),N.value?(i(),n("div",he,"Loading accounts...")):p.value.length===0?(i(),n("div",ge," No accounts found for this customer. ")):(i(),n("table",ke,[s[7]||(s[7]=e("thead",null,[e("tr",null,[e("th",null,"IBAN"),e("th",null,"Type"),e("th",null,"Balance"),e("th",null,"Absolute Limit"),e("th",null,"Daily Limit"),e("th",null,"Status"),e("th",null,"Actions")])],-1)),e("tbody",null,[(i(!0),n($,null,M(p.value,t=>(i(),n("tr",{key:t.iban},[e("td",null,a(t.iban),1),e("td",null,a(t.accountType),1),e("td",null,"€"+a(t.balance.toFixed(2)),1),e("td",null,"€"+a(t.absoluteLimit.toFixed(2)),1),e("td",null,"€"+a(t.dailyLimit.toFixed(2)),1),e("td",null,a(t.active?"Active":"Inactive"),1),e("td",null,[e("button",{onClick:o=>J(t),class:"update-btn"}," Update Limits ",8,_e),t.active?(i(),n("button",{key:0,onClick:o=>O(t.iban),class:"close-account-btn"}," Close Account ",8,Le)):v("",!0),t.active?v("",!0):(i(),n("button",{key:1,onClick:o=>Q(t.iban),class:"reopen-account-btn"}," Reopen Account ",8,Ce))])]))),128))])]))]),e("div",Ae,[s[10]||(s[10]=e("h4",null,"Recent Transactions",-1)),T.value?(i(),n("div",Fe,"Loading transactions...")):L.value.length===0?(i(),n("div",we," No transactions found for this customer. ")):(i(),n("table",Ne,[s[9]||(s[9]=e("thead",null,[e("tr",null,[e("th",null,"Date"),e("th",null,"From"),e("th",null,"To"),e("th",null,"Amount"),e("th",null,"Type"),e("th",null,"Initiated By")])],-1)),e("tbody",null,[(i(!0),n($,null,M(L.value,t=>(i(),n("tr",{key:t.id},[e("td",null,a(W(t.timestamp)),1),e("td",null,[e("span",{class:"truncate clickable",title:t.fromIban,onClick:o=>D(t.fromIban,"From IBAN")},a(t.fromIban||"-"),9,Te)]),e("td",null,[e("span",{class:"truncate clickable",title:t.toIban,onClick:o=>D(t.toIban,"To IBAN")},a(t.toIban||"-"),9,Be)]),e("td",{class:te(x(t)+" amount-cell")},[x(t)==="amount-positive"?(i(),n("span",Ie,"+")):x(t)==="amount-negative"?(i(),n("span",xe,"-")):v("",!0),se(" €"+a(t.amount.toFixed(2)),1)],2),e("td",null,a(t.transactionType),1),e("td",null,[e("span",{class:"truncate clickable",title:t.initiatedByFullName,onClick:o=>D(t.initiatedByFullName,"Initiated By")},a(t.initiatedByFullName||"-"),9,De)])]))),128))])])),h.value.visible?(i(),n("div",{key:3,class:"expand-popup-overlay",onClick:E(R,["self"])},[e("div",$e,[e("div",Me,[e("span",Ee,a(h.value.label),1),e("button",{class:"popup-close",onClick:R},"×")]),e("div",Pe,a(h.value.value),1)])])):v("",!0)])])])):v("",!0),B.value?(i(),n("div",{key:5,class:"modal-overlay",onClick:F},[e("div",{class:"modal-content limits-modal",onClick:s[4]||(s[4]=E(()=>{},["stop"]))},[e("div",{class:"modal-header"},[s[11]||(s[11]=e("h3",null,"Update Account Limits",-1)),e("button",{onClick:F,class:"close-btn"},"×")]),e("div",Ue,[e("div",Ve,[s[12]||(s[12]=e("label",null,"Absolute Limit (€)",-1)),P(e("input",{type:"number","onUpdate:modelValue":s[1]||(s[1]=t=>m.value.absoluteLimit=t),min:"0",step:"0.01"},null,512),[[U,m.value.absoluteLimit]])]),e("div",Re,[s[13]||(s[13]=e("label",null,"Daily Limit (€)",-1)),P(e("input",{type:"number","onUpdate:modelValue":s[2]||(s[2]=t=>m.value.dailyLimit=t),min:"0",step:"0.01"},null,512),[[U,m.value.dailyLimit]])]),e("div",Se,[s[14]||(s[14]=e("label",null,"Daily Transfer Limit (€)",-1)),P(e("input",{type:"number","onUpdate:modelValue":s[3]||(s[3]=t=>m.value.dailyTransferLimit=t),min:"0",step:"0.01"},null,512),[[U,m.value.dailyTransferLimit]])]),e("div",{class:"form-actions"},[e("button",{onClick:K,class:"save-btn"},"Save"),e("button",{onClick:F,class:"cancel-btn"},"Cancel")])])])])):v("",!0)]))}},He=Y(ze,[["__scopeId","data-v-698a5c5c"]]);export{He as default};
